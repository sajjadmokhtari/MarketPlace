<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>داشبورد | MarketPlace</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg1: #667eea;
      --bg2: #764ba2;
      --panel: rgba(255,255,255,0.15);
      --border: rgba(255,255,255,0.25);
      --text: #fff;
      --muted: rgba(255,255,255,0.85);
      --btn: #10b981;
      --btn-hover: #34d399;
      --danger: #ef4444;
      --danger-hover: #dc2626;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; font-family: 'Vazirmatn', Tahoma, sans-serif; }
    body {
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text);
      display: flex;
      flex-direction: column;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 18px;
    }
    .brand .dot {
      width: 10px;
      height: 10px;
      background: var(--btn);
      border-radius: 50%;
      box-shadow: 0 0 10px #fff8;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    .btn {
      background: var(--btn);
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      text-decoration: none;
    }
    .btn:hover { background: var(--btn-hover); }
    .btn-danger {
      background: var(--danger);
    }
    .btn-danger:hover { background: var(--danger-hover); }
    .container {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 16px;
      flex: 1;
    }
    .grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      transition: transform 0.2s, background 0.3s;
      cursor: pointer;
    }
    .card:hover {
      transform: translateY(-4px);
      background: rgba(255,255,255,0.25);
    }
    .card i {
      font-size: 28px;
      margin-bottom: 10px;
      color: var(--muted);
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .card-value {
      font-size: 20px;
      font-weight: 700;
      transition: all 0.5s ease;
    }
  </style>
</head>
<body>

<header class="header">
  <div class="brand">
    <span class="dot"></span>
    <span>MarketPlace</span>
  </div>
  <div class="actions">
    <a class="btn" href="/order"><i class="fa fa-plus"></i> ثبت آگهی</a>
    <button class="btn btn-danger" id="logoutBtn"><i class="fa fa-sign-out-alt"></i> خروج</button>
  </div>
</header>

<main class="container">
  <div class="grid">
    <div class="card" onclick="window.location.href='/listings'">
      <i class="fa fa-store"></i>
      <div class="card-title">نمایش آگهی‌ها</div>
    </div>
    <div class="card">
      <i class="fa fa-bullhorn"></i>
      <div class="card-title">آگهی‌های فعال</div>
      <div class="card-value" id="activeListingsCount">0</div>
    </div>
    <div class="card">
      <i class="fa fa-clock"></i>
      <div class="card-title">در انتظار تأیید</div>
      <div class="card-value" id="pendingListingsCount">0</div>
    </div>
    <div class="card">
      <i class="fa fa-envelope"></i>
      <div class="card-title">پیام‌های خوانده‌نشده</div>
      <div class="card-value" id="unreadMessagesCount">0</div>
    </div>
    <div class="card" onclick="checkAdminAccess()">
      <i class="fa fa-user-shield"></i>
      <div class="card-title">تست دسترسی ادمین</div>
      <div class="card-value" id="adminTestResult">...</div>
    </div>
  </div>
</main>

<script>
function animateCount(el, target) {
  let current = 0;
  const step = Math.ceil(target / 50);
  const interval = setInterval(() => {
    current += step;
    if (current >= target) {
      current = target;
      clearInterval(interval);
    }
    el.textContent = current;
  }, 15);
}

async function loadActiveListingsCount() {
  try {
    const res = await fetch('/api/active-list');
    const data = await res.json();
    animateCount(document.getElementById('activeListingsCount'), data.count || 0);
  } catch {
    animateCount(document.getElementById('activeListingsCount'), 0);
  }
}

async function loadOtherCounts() {
  try {
    const res = await fetch('/api/pending-list');
    const data = await res.json();
    animateCount(document.getElementById('pendingListingsCount'), data.count || 0);
  } catch {
    animateCount(document.getElementById('pendingListingsCount'), 0);
  }

  try {
    const res = await fetch('/api/unread-messages');
    const data = await res.json();
    animateCount(document.getElementById('unreadMessagesCount'), data.count || 0);
  } catch {
    animateCount(document.getElementById('unreadMessagesCount'), 0);
  }
}

async function checkAdminAccess() {
  try {
    const res = await fetch('/admin/test', {
      method: 'GET',
      credentials: 'include'
    });
    const data = await res.json();
    document.getElementById('adminTestResult').textContent = data.message || "✅ موفق";
  } catch (err) {
    document.getElementById('adminTestResult').textContent = "❌ دسترسی غیرمجاز یا خطا";
  }
}

document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    const res = await fetch('/api/logout', {
      method: 'POST',
      credentials: 'include'
    });
    const data = await res.json();
    if (res.ok) {
      alert(data.message || "✅ خروج با موفقیت انجام شد");
      window.location.href = '/';
    } else {
      alert(data.error || "❌ خطا در خروج از حساب");
    }
  } catch (err) {
    alert("❌ ارتباط با سرور برقرار نشد");
  }
});

document.addEventListener('DOMContentLoaded', () => {
  loadActiveListingsCount();
  loadOtherCounts();
});
</script>

</body>
</html>
